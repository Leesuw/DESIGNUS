<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.designus.www.dao.IauctionDao">

	<insert id="getAuctionWriteInsert" parameterType="auction">
		INSERT INTO AU VALUES(AU_SEQ.NEXTVAL,#{au_mbid_w},#{au_title},#{au_cgcode},#{au_qty},#{au_minprice},#{au_inprice},#{au_contents},DEFAULT)
	</insert>

	<insert id="getAuctionBasketInsert" parameterType="basket">
		INSERT INTO AUCTION_BASKET VALUES(${ab_aunum},#{ab_mbid})
	</insert>
	
	<delete id="getAuctionBasketDelete" parameterType="basket">
		DELETE FROM AUCTION_BASKET WHERE AB_AUNUM = ${ab_aunum} AND AB_MBID = #{ab_mbid}
	</delete>
		
	<select id="getAuctionBasketSelect" parameterType="basket" resultType="Integer">
		SELECT NVL(max(ab_aunum),0)FROM AUCTION_BASKET WHERE AB_AUNUM = ${ab_aunum} AND AB_MBID = #{ab_mbid}
	</select>	

	<select id="getAuctionListSelect" parameterType="auction" resultType="auction">
	  <![CDATA[
		SELECT a.au_num, a.au_mbid_w, a.au_title, a.au_cgcode, a.au_qty, a.au_minprice, a.au_inprice,
		a.au_contents, a.au_date, b.aut_price FROM AU a LEFT OUTER JOIN 
		(select aut_aunum,MAX(aut_price)as aut_price FROM aut where aut_kind != 'I' group by aut_aunum) b
		ON  a.AU_NUM = b.AUT_AUNUM
		where a.au_cgcode = ${au_cgcode}
		ORDER BY a.AU_NUM
      ]]>
		
	</select>

	<select id="getAuctionListSelect2" parameterType="String" resultType="auction">
	   SELECT * FROM AU WHERE UPPER(AU_TITLE) LIKE UPPER('%'||#{word}||'%') OR UPPER(AU_CONTENTS) LIKE UPPER('%'||#{word}||'%')
	</select>

	<select id="getAuctionReadSelect" parameterType="auction" resultType="auction">
		SELECT * FROM AU WHERE AU_NUM = ${au_num}
	</select>
	

	<select id="getAuctionTenderPrice" parameterType="auctiontender" resultType="Integer">
		SELECT AU_INPRICE FROM AU WHERE AU_NUM = ${aut_aunum}
	</select>

	<insert id="setAuctionTenderI" parameterType="auctiontender">
		INSERT INTO AUCTIONTENDER VALUES(${aut_aunum},#{aut_mbid},${aut_price},'I',DEFAULT)
	</insert>

	<insert id="setAuctionTenderT" parameterType="auctiontender">
		INSERT INTO AUCTIONTENDER VALUES(${aut_aunum},#{aut_mbid},${aut_price},'T',DEFAULT)
	</insert>
	
	<update id="setAuctionTenderDel" parameterType="auctiontender">
		UPDATE AU SET AU_QTY = AU_QTY-(${aut_price}/AU_INPRICE) WHERE AU_NUM = ${aut_aunum}
	</update>

	<select id="auctionTenderSel" parameterType="auctiontender" resultType="String">
		SELECT max(AUT_PRICE) FROM AUCTIONTENDER WHERE aut_aunum = ${aut_aunum} AND aut_kind != 'I'
	</select>

	<select id="auctionTenderPriceSel" parameterType="auctiontender" resultType="Integer">
		SELECT AU_MINPRICE FROM AU WHERE AU_NUM = ${aut_aunum}
	</select>

	<select id="getAuctionTenderQty" parameterType="auctiontender" resultType="Integer">
		SELECT AU_QTY-${aut_qty} FROM AU WHERE au_num = ${aut_aunum}
	</select>

	<select id="getAuctionInfoID" parameterType="auction" resultType="String">
		SELECT AU_MBID_W FROM AU WHERE au_num = ${au_num}
	</select>

	<select id="getAuctionTenderList" parameterType="auctiontender" resultType="auctiontender">
		  <![CDATA[
		SELECT *FROM(SELECT ROWNUM AS A, AUT_AUNUM, AUT_MBID, AUT_PRICE, AUT_KIND 
        FROM AUT  
        WHERE AUT_AUNUM = ${aut_aunum} AND AUT_KIND != 'I' AND AUT_KIND !='O'
        ORDER BY AUT_PRICE DESC
        )WHERE  ROWNUM <=3
 		]]>
	</select>

	<select id="getAuctionWriterListSel" parameterType="auction" resultType="auction">
		  <![CDATA[
		SELECT * FROM AU 
		WHERE ROWNUM <=3 AND AU_NUM != ${au_num} AND AU_MBID_W = #{au_mbid_w}
		ORDER BY AU_NUM DESC
 		]]>
	</select>

	<insert id="setAuctionUTI" parameterType="auctiontender">
		INSERT INTO AUCTION_PROGRESS
        VALUES(AUP_SEQ.NEXTVAL,${aut_aunum},#{aut_mbid},DEFAULT,DEFAULT,DEFAULT,${aut_qty},${aut_price},DEFAULT,1,DEFAULT)
	</insert>

	<!-- aup 등록 sql 
	<insert id="setAuctionUTT" parameterType="auctiontender">
		INSERT INTO AUCTION_PROGRESS
        VALUES(AUP_SEQ.NEXTVAL,${aut_aunum},#{aut_mbid},DEFAULT,DEFAULT,DEFAULT,1,${aut_price},DEFAULT,1,DEFAULT)
	</insert> 
	
	--> 
 
	<select id="getAuctionWriteSel" parameterType="auction" resultType="Integer">
		SELECT MAX(AU_NUM) FROM AU
	</select>

	<select id="getAuctionWriteIdSel" parameterType="auction" resultType="String">
		SELECT AU_MBID_W FROM AU WHERE AU_NUM = ${au_num}
	</select>
     <!-- 출품 이미지 등록 -->
	<insert id="AuctionImageInsert1" parameterType="auction">
		INSERT INTO AUI
        VALUES(${au_num},#{aui_imgSysName1})
	</insert>
	<insert id="AuctionImageInsert2" parameterType="auction">
		INSERT INTO AUI
        VALUES(${au_num},#{aui_imgSysName2})
	</insert>
	<insert id="AuctionImageInsert3" parameterType="auction">
		INSERT INTO AUI
        VALUES(${au_num},#{aui_imgSysName3})
	</insert>
	<insert id="AuctionImageInsert4" parameterType="auction">
		INSERT INTO AUI
        VALUES(${au_num},#{aui_imgSysName4})
	</insert>
	<!-- 출품 이미지 등록 -->
	
	<select id="getAuctionImgSel" parameterType="auction" resultType="String">
		<![CDATA[
		SELECT * FROM (
		SELECT ROWNUM AS RN, AUI_NUM, AUI_IMG, ROW_NUMBER()
		OVER(PARTITION BY AUI_NUM ORDER BY AUI_IMG ) AS AUI
		FROM AUI WHERE AUI_NUM = ${au_num}
		) WHERE AUI = 1
		]]>
	</select>
	
	<insert id="setNotifyAuctionInsert" parameterType="auction">
		INSERT INTO NOTIFY VALUES(NF_SEQ.NEXTVAL,#{au_mbid_w},DEFAULT,#{au_contents},0,DEFAULT)
	</insert>

	<select id="getAuctionWID" parameterType="auctiontender" resultType="String">
		SELECT AU_MBID_W FROM AU WHERE AU_NUM = ${aut_aunum}
	</select>
	
	<select id="getAuctionTitle" parameterType="auctiontender" resultType="String">
		SELECT AU_TITLE FROM AU WHERE AU_NUM = ${aut_aunum}
	</select>

	<insert id="setNotifyAuctionTender" parameterType="auctiontender">
		INSERT INTO NOTIFY VALUES(NF_SEQ.NEXTVAL,#{aut_mbid},DEFAULT,#{aut_notify},0,DEFAULT)
	</insert>
	
</mapper>